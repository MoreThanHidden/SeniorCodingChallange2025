@page
@model IndexModel
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@{
    ViewData["Title"] = "Home page";
}
@if (SignInManager.IsSignedIn(User))
{

    var filteredProviders = string.IsNullOrEmpty(Model.SelectedHospital) ? Model.Providers : Model.Providers.Where(p => p.Hospital == Model.SelectedHospital);

    
    
    var user = await UserManager.GetUserAsync(User);
    var roles = await UserManager.GetRolesAsync(user);
    
    
    if (roles.Contains("Administrator"))
    {
        <h2>Administrator View:</h2>
    }
    else if (roles.Contains("Clerk"))
    {
        <h2>Clerk View:</h2>
    }
    else if (roles.Contains("Doctor"))
    {
        <h2>Doctor View:</h2>
    }
    else if (roles.Contains("Nurse"))
    {
        <h2>Nurse View:</h2>
    }
    
    var selectedProviderName = Request.Query["selectedProviderName"].ToString();
    
    <table class="table w-75" >
        <tr>
            <th>Roles:</th>
            <td>@string.Join(", ", roles)</td>
        </tr>
        <tr>
            <th>Username:</th>
            <td>@user.UserName</td>
        </tr>
        <tr>
            <th>Your Name: (For Testing)</th>
            <td>
                <form method="get" class="d-inline">
                    <input type="hidden" name="selectedHospital" value="@Model.SelectedHospital" />
                    <select class="form-control w-75 d-inline" name="selectedProviderName" onchange="this.form.submit()">
                        <option value="">-- Select Your Name --</option>
                        @if (roles.Contains("Doctor"))
                        {
                            foreach (var provider in filteredProviders.Where(p => p.Doctor))
                            {
                                if (provider.Name == selectedProviderName)
                                {
                                    <option value="@provider.Name" selected>@provider.Name (@provider.Hospital)</option>
                                }
                                else
                                {
                                    <option value="@provider.Name">@provider.Name (@provider.Hospital)</option>
                                }
                            }
                        }
                        else if (roles.Contains("Nurse"))
                        {
                            foreach (var provider in filteredProviders.Where(p => !p.Doctor))
                            {
                                if (provider.Name == selectedProviderName)
                                {
                                    <option value="@provider.Name" selected>@provider.Name (@provider.Hospital)</option>
                                }
                                else
                                {
                                    <option value="@provider.Name">@provider.Name (@provider.Hospital)</option>
                                }
                            }
                        }
                    </select>
                </form>
            </td>
        </tr>
        <tr>
            <th>Hospital</th>
            <td>
                <form method="get" class="d-inline">
                    <input type="hidden" name="selectedProviderName" value="@selectedProviderName" />
                    <select id="hospitalSelect" name="selectedHospital" class="form-control" onchange="this.form.submit()">
                        <option value="">-- All Hospitals --</option>
                        @foreach (var hospital in Model.Hospitals)
                        {
                            if (hospital.Name == Model.SelectedHospital)
                            {
                                <option value="@hospital.Name" selected>@hospital.Name</option>
                            }
                            else
                            {
                                <option value="@hospital.Name">@hospital.Name</option>
                            }
                        }
                    </select>
                </form>
            </td>
        </tr>
    </table>

    
    if (!string.IsNullOrEmpty(selectedProviderName) && (roles.Contains("Doctor") || roles.Contains("Nurse")))
    {
        <h4>Your Patients</h4>
        var userPatients = Model.Treatments.Where(t => t.Provider == selectedProviderName)
            .Select(t => Model.Patients.FirstOrDefault(p => p.MedicalReferenceNumber == t.Patient || p.PatientName == t.Patient))
            .Where(p => p != null)
            .Distinct()
            .ToList();
        if (userPatients.Any())
        {
            <ul>
            @foreach (var patient in userPatients)
            {
                <li>@patient.PatientName (@patient.MedicalReferenceNumber)</li>
            }
            </ul>
        }
        else
        {
            <div class="alert alert-warning">No patients to display.</div>
        }
    }
    <h4>Patients Admitted to This Practice (No Treatment Yet)</h4>
    @if (!string.IsNullOrEmpty(Model.SelectedHospital))
    {
        var admittedPatients = Model.Patients
            .Where(p => Model.Treatments.All(t => t.Patient != p.MedicalReferenceNumber && t.Patient != p.PatientName))
            .ToList();
        if (admittedPatients.Any())
        {
            <ul>
            @foreach (var patient in admittedPatients)
            {
                <li>@patient.PatientName (@patient.MedicalReferenceNumber)</li>
            }
            </ul>
        }
        else
        {
            <div class="alert alert-warning">No admitted patients without treatment for this practice.</div>
        }
    }
    <h2>Providers</h2>
    <p>Number of Providers: @filteredProviders.Count()</p>
    <table class="table table-bordered table-striped">
        <thead>
        <tr>
            <th>Name</th>
            <th>Number</th>
            <th>Hospital</th>
            <th>Doctor</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var provider in filteredProviders)
        {
            <tr>
                <td>@provider.Name</td>
                <td>@provider.Number</td>
                <td>@provider.Hospital</td>
                <td>@(provider.Doctor ? "Yes" : "No")</td>
            </tr>
        }
        </tbody>
    </table>
    
}
else
{
    <div class="alert alert-info">You must be logged in to view provider data.</div>
}
